# Best Practices

## OpenAPI Spec 编写

1. **status enum 必须完整**：所有后端可能返回的 status 值都必须列在 spec 的 enum 中。新增状态值时，改 spec 是第一步，不是最后一步。

2. **使用 `$ref` 避免重复**：所有在多个端点出现的 schema（如 `ErrorResponse`, `CrawlStats`）统一定义在 `components/schemas` 中。

3. **`required` 字段必须显式列出**：不依赖工具默认行为。Go 的 `omitempty` 对应 spec 中的非 required 字段。

4. **nullable vs optional**：OpenAPI 3.1 中 `nullable` 已废弃，使用 `type: ["string", "null"]` 或 `oneOf` 表达可空类型。

## 代码生成

1. **生成代码不手动编辑**：`types.gen.go` 和 `web/src/api/generated/` 目录中的文件顶部标注 `// Code generated by ... DO NOT EDIT.`

2. **`.gitignore` 不忽略生成文件**：生成的代码提交到仓库，确保 `go build` 和前端构建不依赖外部工具。CI 中 `make generate-check` 验证一致性。

3. **渐进式替换**：不需要一次性替换所有手写 schema。可以先替换出过问题的部分（如 `sync-schemas.ts`），再逐步迁移其他 schema。

## CI 冒烟测试

1. **独立的 compose 文件**：CI 使用 `docker-compose.ci.yml`，内联所有环境变量，不依赖 `.env` 文件。避免 CI 中因缺少 `.env` 而失败。

2. **确定性的测试数据**：冒烟测试不依赖外部 API（npan API），只验证服务启动和端点可达。搜索返回空结果是正确行为。

3. **失败时导出日志**：`if: failure()` 步骤中执行 `docker compose logs` 方便调试。

4. **Docker 层缓存**：使用 Buildx + `type=gha,mode=max` 缓存所有中间层。`bun install` 和 `go mod download` 在依赖不变时能命中缓存。

## 安全注意事项

1. **CI 中的 API Key**：`docker-compose.ci.yml` 中使用硬编码的测试 key，不存储真实凭据。

2. **Meilisearch Master Key**：CI 中使用固定的测试 key，与 npan 的 `MEILI_API_KEY` 保持一致。

3. **不在冒烟测试中暴露敏感端点**：冒烟测试只验证 health、search、admin sync 等端点，不涉及 token 获取等需要真实凭据的操作。

## oapi-codegen 与 Echo v5 兼容性

oapi-codegen 当前不支持 Echo v5（v5 将 `echo.Context` 改为 `*echo.Context`）。因此：

- **只生成 types，不生成 server interface**
- Handler 代码继续手写，但使用生成的 type 做序列化
- 等 oapi-codegen 支持 Echo v5 后可以启用 `strict-server` 或 `echo-server`
