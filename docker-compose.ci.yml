# CI-only Docker Compose â€” no persistent volumes, inline env, fast healthchecks.
# Usage: docker compose -f docker-compose.ci.yml up --build -d

services:
  meilisearch:
    image: getmeili/meilisearch:v1.35.1
    container_name: meilisearch-ci
    ports:
      - "17700:7700"
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: ci-test-meili-key-5678
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:7700/health || wget -q -O /dev/null http://127.0.0.1:7700/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  npan:
    build:
      context: .
      cache_from:
        - type=gha
      cache_to:
        - type=gha,mode=max
    container_name: npan-ci
    depends_on:
      meilisearch:
        condition: service_healthy
    ports:
      - "11323:1323"
      - "19091:9091"
    environment:
      MEILI_HOST: http://meilisearch:7700
      MEILI_API_KEY: ci-test-meili-key-5678
      MEILI_INDEX: npan_items
      METRICS_ADDR: ":9091"
      NPA_ADMIN_API_KEY: ci-test-admin-api-key-1234
      NPA_ALLOW_CONFIG_AUTH_FALLBACK: "true"
      NPA_TOKEN: ci-dummy-token
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:1323/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10

  playwright:
    image: mcr.microsoft.com/playwright:v1.58.2-noble
    container_name: playwright-ci
    depends_on:
      npan:
        condition: service_healthy
    ipc: host
    init: true
    working_dir: /web
    volumes:
      - ./web:/web
    environment:
      BASE_URL: http://npan:1323
      MEILI_HOST: http://meilisearch:7700
      MEILI_API_KEY: ci-test-meili-key-5678
      MEILI_INDEX: npan_items
      E2E_ADMIN_API_KEY: ci-test-admin-api-key-1234
      CI: "true"
    command: sh -c "npm install 2>/dev/null; npx playwright test"
    profiles:
      - e2e
