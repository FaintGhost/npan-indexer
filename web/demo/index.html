<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Npan Search Demo</title>
    <meta name="description" content="Npan 文件搜索与直接下载 Demo" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=ZCOOL+XiaoWei&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      :root {
        --paper: #f3f6fd;
        --paper-dark: #e9eefb;
      }

      body {
        font-family: "Noto Sans SC", sans-serif;
        background:
          radial-gradient(
            1200px 560px at 50% -260px,
            #dae6ff 0%,
            transparent 72%
          ),
          linear-gradient(180deg, #f9fbff 0%, #f3f6fd 100%);
        background-attachment: fixed;
      }

      .font-display {
        font-family: "ZCOOL XiaoWei", serif;
      }

      /* ================= 动画优化核心区 ================= */

      /* 为重要元素分配独立的 View Transition 图层 */
      .search-stage {
        position: sticky;
        top: 0;
        z-index: 50;
        width: 100%;
        /* 只保留颜色相关的常规过渡，防止和布局过渡打架 */
        transition:
          background-color 400ms ease,
          border-color 400ms ease;
        view-transition-name: search-stage;
      }

      .search-card {
        transition: box-shadow 400ms ease;
        view-transition-name: search-card;
      }

      .results-wrap {
        position: relative;
        z-index: 10;
        view-transition-name: results-wrap;
      }

      /* 重写 View Transition 的默认行为，减缓速度，增加丝滑的阻尼感 */
      ::view-transition-group(search-stage),
      ::view-transition-group(search-card),
      ::view-transition-group(results-wrap) {
        animation-duration: 650ms;
        animation-timing-function: cubic-bezier(0.22, 1, 0.36, 1);
      }

      /* ============================================== */

      /* 锁死默认状态的滚动 */
      body.mode-hero {
        overflow: hidden;
      }

      /* 默认状态：全屏居中 */
      body.mode-hero .search-stage {
        height: 100vh;
        height: 100dvh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border-bottom: 1px solid transparent;
      }

      body.mode-hero .search-card {
        transform: scale(1.02);
        box-shadow: 0 24px 60px rgba(23, 48, 105, 0.14);
      }

      /* 默认状态下，结果列表在屏幕下方待命，保持实际宽度，防止从角落闪现 */
      body.mode-hero .results-wrap {
        opacity: 0;
        pointer-events: none;
        transform: translateY(60px);
      }

      /* 搜索状态：吸顶 + 毛玻璃遮挡 */
      body.mode-docked .search-stage {
        height: auto;
        padding-top: 16px;
        padding-bottom: 16px;
        background: rgba(243, 246, 253, 0.85);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(218, 230, 255, 0.6);
        box-shadow: 0 4px 24px -8px rgba(23, 48, 105, 0.08);
      }

      body.mode-docked .search-card {
        transform: scale(1);
        box-shadow: 0 4px 16px rgba(23, 48, 105, 0.04);
      }

      body.mode-docked .results-wrap {
        opacity: 1;
        transform: translateY(0);
      }

      /* 滚动条与其他细节样式 */
      .thin-scrollbar {
        scrollbar-width: thin;
      }

      .thin-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .thin-scrollbar::-webkit-scrollbar-thumb {
        background: #ced7ea;
        border-radius: 9999px;
      }

      ::view-transition-old(results-list),
      ::view-transition-new(results-list) {
        animation-duration: 300ms;
        animation-timing-function: ease;
      }

      ::view-transition-old(result-card),
      ::view-transition-new(result-card) {
        animation-duration: 300ms;
        animation-timing-function: ease;
      }
    </style>
  </head>
  <body class="mode-hero text-slate-800 antialiased">
    <header class="search-stage">
      <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 w-full">
        <div
          class="search-card w-full rounded-3xl border border-slate-200/90 bg-white p-4 sm:p-6"
        >
          <div
            class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between"
          >
            <div>
              <h1
                class="font-display text-4xl leading-tight tracking-wide text-slate-900"
              >
                Npan Search
              </h1>
              <p class="mt-1 text-sm text-slate-500">
                像搜索引擎一样查找文件，命中后直接下载。
              </p>
            </div>
            <div
              class="rounded-full border border-blue-100 bg-blue-50 px-3 py-1 text-xs font-medium text-blue-700"
            >
              Tailwind v4 + View Transition
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 gap-3 sm:grid-cols-[1fr_auto]">
            <input
              id="queryInput"
              type="text"
              autocomplete="off"
              placeholder="输入文件名关键词，例如：MX40、固件、安装包"
              class="h-12 w-full rounded-xl border border-slate-200 bg-white px-4 text-[15px] text-slate-800 outline-none ring-blue-100 transition focus:border-blue-300 focus:ring-4"
            />
            <button
              id="searchBtn"
              type="button"
              class="h-12 rounded-xl bg-blue-600 px-5 text-sm font-semibold text-white shadow-md shadow-blue-200 transition hover:bg-blue-500 active:scale-[0.99]"
            >
              搜索
            </button>
          </div>

          <p id="status" class="mt-3 min-h-5 text-xs text-slate-500">
            请输入关键词开始搜索
          </p>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-3xl px-4 pb-16 sm:px-6 lg:px-8">
      <section id="resultsWrap" class="results-wrap mt-2">
        <div class="mb-3 flex items-center justify-between">
          <p class="text-sm text-slate-500">结果列表</p>
          <p id="counter" class="text-sm font-medium text-slate-600">0 / 0</p>
        </div>

        <div
          id="list"
          class="thin-scrollbar space-y-3"
          style="view-transition-name: results-list"
          aria-live="polite"
        ></div>
        <div id="sentinel" class="h-2"></div>
      </section>
    </main>

    <script>
      const state = {
        query: "",
        items: [],
        page: 1,
        pageSize: 24,
        total: 0,
        loading: false,
        hasMore: false,
        requestSeq: 0,
        abortController: null,
        debounceTimer: null,
        linkCache: new Map(),
        docked: false,
      };

      const el = {
        queryInput: document.getElementById("queryInput"),
        searchBtn: document.getElementById("searchBtn"),
        status: document.getElementById("status"),
        counter: document.getElementById("counter"),
        list: document.getElementById("list"),
        sentinel: document.getElementById("sentinel"),
        resultsWrap: document.getElementById("resultsWrap"),
      };

      function setStatus(text, isError) {
        el.status.textContent = text || "";
        el.status.className =
          "mt-3 min-h-5 text-xs " +
          (isError ? "text-rose-600" : "text-slate-500");
      }

      function runViewTransition(update) {
        if (!document.startViewTransition) {
          update();
          return Promise.resolve();
        }
        const tx = document.startViewTransition(update);
        return tx.finished.catch(() => undefined);
      }

      async function applyMode(docked) {
        if (state.docked === docked) {
          return;
        }
        state.docked = docked;
        await runViewTransition(() => {
          document.body.classList.toggle("mode-docked", docked);
          document.body.classList.toggle("mode-hero", !docked);
        });
      }

      function requestJSON(path, params, signal) {
        const url = new URL(path, window.location.origin);
        Object.keys(params || {}).forEach((key) => {
          const val = params[key];
          if (val !== undefined && val !== null && val !== "") {
            url.searchParams.set(key, String(val));
          }
        });
        return fetch(url.toString(), { method: "GET", signal }).then(async (resp) => {
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) {
            throw new Error(data.error || "请求失败: HTTP " + resp.status);
          }
          return data;
        });
      }

      function abortInFlight() {
        if (state.abortController) {
          state.abortController.abort();
          state.abortController = null;
        }
        state.loading = false;
      }

      function escapeHTML(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function formatTime(ts) {
        const raw = Number(ts || 0);
        if (!raw) {
          return "-";
        }
        const millis = raw > 1_000_000_000_000 ? raw : raw * 1000;
        const d = new Date(millis);
        if (Number.isNaN(d.getTime())) {
          return "-";
        }
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return y + "-" + m + "-" + day + " " + hh + ":" + mm;
      }

      function formatBytes(size) {
        const value = Number(size || 0);
        if (!value) {
          return "-";
        }
        const units = ["B", "KB", "MB", "GB", "TB"];
        let idx = 0;
        let num = value;
        while (num >= 1024 && idx < units.length - 1) {
          num /= 1024;
          idx += 1;
        }
        return num.toFixed(num >= 10 || idx === 0 ? 0 : 1) + " " + units[idx];
      }

      function cardHTML(item) {
        const id = Number(item.source_id || 0);
        const name = String(item.name || "");
        const pathText = String(item.path_text || "-");
        const modifiedAt = formatTime(item.modified_at);
        const size = formatBytes(item.size);

        return (
          '<article class="group rounded-2xl border border-slate-200 bg-white px-4 py-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md sm:px-5" style="view-transition-name: result-card;">' +
          '<div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">' +
          '<div class="min-w-0">' +
          '<h3 class="truncate text-[15px] font-semibold text-slate-900">' +
          escapeHTML(name) +
          "</h3>" +
          '<p class="mt-1 truncate text-xs text-slate-500">' +
          escapeHTML(pathText) +
          "</p>" +
          '<p class="mt-2 text-xs text-slate-400">ID: ' +
          id +
          " · 大小: " +
          size +
          " · 更新时间: " +
          modifiedAt +
          "</p>" +
          "</div>" +
          '<button data-action="download" data-id="' +
          id +
          '" class="h-10 shrink-0 rounded-xl bg-slate-900 px-4 text-sm font-medium text-white transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50">下载</button>' +
          "</div>" +
          "</article>"
        );
      }

      function renderSkeleton(count) {
        const blocks = [];
        for (let i = 0; i < count; i += 1) {
          blocks.push(
            '<div class="animate-pulse rounded-2xl border border-slate-200 bg-white px-4 py-4 sm:px-5">' +
              '<div class="h-4 w-2/3 rounded bg-slate-200"></div>' +
              '<div class="mt-2 h-3 w-5/6 rounded bg-slate-100"></div>' +
              '<div class="mt-3 h-3 w-1/2 rounded bg-slate-100"></div>' +
              "</div>",
          );
        }
        return blocks.join("");
      }

      function renderList() {
        el.counter.textContent = state.items.length + " / " + state.total;
        if (!state.items.length) {
          el.list.innerHTML =
            '<div class="rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-12 text-center text-sm text-slate-500">没有匹配结果，试试更短或更常见的关键词。</div>';
          return;
        }
        el.list.innerHTML = state.items.map(cardHTML).join("");
      }

      function resetSearch(query) {
        abortInFlight();
        state.requestSeq += 1;
        state.query = query;
        state.items = [];
        state.page = 1;
        state.total = 0;
        state.hasMore = false;
        state.linkCache.clear();
      }

      async function fetchPage(page, replaceMode) {
        if (!state.query) {
          return;
        }
        if (replaceMode && state.loading) {
          abortInFlight();
        }
        if (!replaceMode && state.loading) {
          return;
        }
        if (!replaceMode && !state.hasMore) {
          return;
        }

        const seq = state.requestSeq;
        const controller = new AbortController();
        state.abortController = controller;
        state.loading = true;
        setStatus(replaceMode ? "搜索中..." : "正在加载更多...");
        if (replaceMode) {
          await runViewTransition(() => {
            el.list.innerHTML = renderSkeleton(5);
            el.counter.textContent = "0 / 0";
          });
        }

        try {
          const data = await requestJSON("/api/v1/demo/search", {
            query: state.query,
            page,
            page_size: state.pageSize,
          }, controller.signal);

          if (seq !== state.requestSeq) {
            return;
          }

          const incoming = Array.isArray(data.items) ? data.items : [];
          state.total = Number(data.total || 0);
          state.page = page;

          if (replaceMode) {
            state.items = incoming;
          } else {
            const seen = new Set(state.items.map((x) => Number(x.source_id)));
            for (const item of incoming) {
              const id = Number(item.source_id || 0);
              if (!seen.has(id)) {
                seen.add(id);
                state.items.push(item);
              }
            }
          }

          state.hasMore =
            state.items.length < state.total && incoming.length > 0;
          await applyMode(state.items.length > 0);
          await runViewTransition(() => {
            renderList();
          });
          setStatus(
            "已加载 " + state.items.length + " / " + state.total + " 个文件",
          );
        } catch (error) {
          if (error && error.name === "AbortError") {
            return;
          }
          setStatus(error.message || String(error), true);
          if (!state.items.length) {
            await applyMode(false);
            await runViewTransition(() => {
              renderList();
            });
          }
        } finally {
          if (state.abortController === controller) {
            state.abortController = null;
          }
          if (seq === state.requestSeq) {
            state.loading = false;
          }
        }
      }

      async function triggerSearch() {
        const query = el.queryInput.value.trim();
        if (!query) {
          resetSearch("");
          await applyMode(false);
          await runViewTransition(() => {
            el.list.innerHTML =
              '<div class="rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-12 text-center text-sm text-slate-500">请输入关键词开始搜索。</div>';
            el.counter.textContent = "0 / 0";
          });
          setStatus("请输入关键词开始搜索");
          return;
        }

        resetSearch(query);
        await fetchPage(1, true);
      }

      async function getDownloadURL(fileID) {
        if (state.linkCache.has(fileID)) {
          return state.linkCache.get(fileID);
        }
        const data = await requestJSON("/api/v1/demo/download-url", {
          file_id: fileID,
        });
        const url = String(data.download_url || "");
        if (!url) {
          throw new Error("下载链接为空");
        }
        state.linkCache.set(fileID, url);
        return url;
      }

      el.searchBtn.addEventListener("click", () => {
        triggerSearch();
      });

      el.queryInput.addEventListener("input", () => {
        if (state.debounceTimer) {
          window.clearTimeout(state.debounceTimer);
        }
        state.debounceTimer = window.setTimeout(() => {
          triggerSearch();
        }, 280);
      });

      el.queryInput.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") {
          return;
        }
        event.preventDefault();
        if (state.debounceTimer) {
          window.clearTimeout(state.debounceTimer);
        }
        triggerSearch();
      });

      el.list.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.getAttribute("data-action") !== "download") {
          return;
        }

        const id = Number(target.getAttribute("data-id") || 0);
        if (!id) {
          return;
        }

        try {
          target.setAttribute("disabled", "disabled");
          setStatus("正在生成下载链接...");
          const url = await getDownloadURL(id);
          window.open(url, "_blank", "noopener,noreferrer");
          setStatus("已打开下载链接");
        } catch (error) {
          setStatus(error.message || String(error), true);
        } finally {
          target.removeAttribute("disabled");
        }
      });

      const observer = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (!entry.isIntersecting) {
              continue;
            }
            if (!state.query || state.loading || !state.hasMore) {
              continue;
            }
            fetchPage(state.page + 1, false);
          }
        },
        { root: null, rootMargin: "180px 0px", threshold: 0.01 },
      );
      observer.observe(el.sentinel);

      el.list.innerHTML =
        '<div class="rounded-2xl border border-dashed border-slate-300 bg-white px-4 py-12 text-center text-sm text-slate-500">请输入关键词开始搜索。</div>';
    </script>
  </body>
</html>
